#include <nessan-gtr/parser.h>

/*
 * Mappings between an opcode and the size of its instruction (including opcode and operands).
 */
static uint8_t opcode_to_instruction_size[] = {
        [0x0] = 2,
        [0x1] = 2,
        [0x2] = 1,
        [0x3] = 2,
        [0x4] = 2,
        [0x5] = 2,
        [0x6] = 2,
        [0x7] = 2,
        [0x8] = 1,
        [0x9] = 2,
        [0xa] = 1,
        [0xb] = 2,
        [0xc] = 3,
        [0xd] = 3,
        [0xe] = 3,
        [0xf] = 3,
        [0x10] = 2,
        [0x11] = 2,
        [0x12] = 1,
        [0x13] = 2,
        [0x14] = 2,
        [0x15] = 2,
        [0x16] = 2,
        [0x17] = 2,
        [0x18] = 1,
        [0x19] = 3,
        [0x1a] = 1,
        [0x1b] = 3,
        [0x1c] = 3,
        [0x1d] = 3,
        [0x1e] = 3,
        [0x1f] = 3,
        [0x20] = 3,
        [0x21] = 2,
        [0x22] = 1,
        [0x23] = 2,
        [0x24] = 2,
        [0x25] = 2,
        [0x26] = 2,
        [0x27] = 2,
        [0x28] = 1,
        [0x29] = 2,
        [0x2a] = 1,
        [0x2b] = 2,
        [0x2c] = 3,
        [0x2d] = 3,
        [0x2e] = 3,
        [0x2f] = 3,
        [0x30] = 2,
        [0x31] = 2,
        [0x32] = 1,
        [0x33] = 2,
        [0x34] = 2,
        [0x35] = 2,
        [0x36] = 2,
        [0x37] = 2,
        [0x38] = 1,
        [0x39] = 3,
        [0x3a] = 1,
        [0x3b] = 3,
        [0x3c] = 3,
        [0x3d] = 3,
        [0x3e] = 3,
        [0x3f] = 3,
        [0x40] = 1,
        [0x41] = 2,
        [0x42] = 1,
        [0x43] = 2,
        [0x44] = 2,
        [0x45] = 2,
        [0x46] = 2,
        [0x47] = 2,
        [0x48] = 1,
        [0x49] = 2,
        [0x4a] = 1,
        [0x4b] = 2,
        [0x4c] = 3,
        [0x4d] = 3,
        [0x4e] = 3,
        [0x4f] = 3,
        [0x50] = 2,
        [0x51] = 2,
        [0x52] = 1,
        [0x53] = 2,
        [0x54] = 2,
        [0x55] = 2,
        [0x56] = 2,
        [0x57] = 2,
        [0x58] = 1,
        [0x59] = 3,
        [0x5a] = 1,
        [0x5b] = 3,
        [0x5c] = 3,
        [0x5d] = 3,
        [0x5e] = 3,
        [0x5f] = 3,
        [0x60] = 1,
        [0x61] = 2,
        [0x62] = 1,
        [0x63] = 2,
        [0x64] = 2,
        [0x65] = 2,
        [0x66] = 2,
        [0x67] = 2,
        [0x68] = 1,
        [0x69] = 2,
        [0x6a] = 1,
        [0x6b] = 2,
        [0x6c] = 3,
        [0x6d] = 3,
        [0x6e] = 3,
        [0x6f] = 3,
        [0x70] = 2,
        [0x71] = 2,
        [0x72] = 1,
        [0x73] = 2,
        [0x74] = 2,
        [0x75] = 2,
        [0x76] = 2,
        [0x77] = 2,
        [0x78] = 1,
        [0x79] = 3,
        [0x7a] = 1,
        [0x7b] = 3,
        [0x7c] = 3,
        [0x7d] = 3,
        [0x7e] = 3,
        [0x7f] = 3,
        [0x80] = 2,
        [0x81] = 2,
        [0x82] = 2,
        [0x83] = 2,
        [0x84] = 2,
        [0x85] = 2,
        [0x86] = 2,
        [0x87] = 2,
        [0x88] = 1,
        [0x89] = 2,
        [0x8a] = 1,
        [0x8b] = 2,
        [0x8c] = 3,
        [0x8d] = 3,
        [0x8e] = 3,
        [0x8f] = 3,
        [0x90] = 2,
        [0x91] = 2,
        [0x92] = 1,
        [0x93] = 2,
        [0x94] = 2,
        [0x95] = 2,
        [0x96] = 2,
        [0x97] = 2,
        [0x98] = 1,
        [0x99] = 3,
        [0x9a] = 1,
        [0x9b] = 3,
        [0x9c] = 3,
        [0x9d] = 3,
        [0x9e] = 3,
        [0x9f] = 3,
        [0xa0] = 2,
        [0xa1] = 2,
        [0xa2] = 2,
        [0xa3] = 2,
        [0xa4] = 2,
        [0xa5] = 2,
        [0xa6] = 2,
        [0xa7] = 2,
        [0xa8] = 1,
        [0xa9] = 2,
        [0xaa] = 1,
        [0xab] = 2,
        [0xac] = 3,
        [0xad] = 3,
        [0xae] = 3,
        [0xaf] = 3,
        [0xb0] = 2,
        [0xb1] = 2,
        [0xb2] = 1,
        [0xb3] = 2,
        [0xb4] = 2,
        [0xb5] = 2,
        [0xb6] = 2,
        [0xb7] = 2,
        [0xb8] = 1,
        [0xb9] = 3,
        [0xba] = 1,
        [0xbb] = 3,
        [0xbc] = 3,
        [0xbd] = 3,
        [0xbe] = 3,
        [0xbf] = 3,
        [0xc0] = 2,
        [0xc1] = 2,
        [0xc2] = 2,
        [0xc3] = 2,
        [0xc4] = 2,
        [0xc5] = 2,
        [0xc6] = 2,
        [0xc7] = 2,
        [0xc8] = 1,
        [0xc9] = 2,
        [0xca] = 1,
        [0xcb] = 2,
        [0xcc] = 3,
        [0xcd] = 3,
        [0xce] = 3,
        [0xcf] = 3,
        [0xd0] = 2,
        [0xd1] = 2,
        [0xd2] = 1,
        [0xd3] = 2,
        [0xd4] = 2,
        [0xd5] = 2,
        [0xd6] = 2,
        [0xd7] = 2,
        [0xd8] = 1,
        [0xd9] = 3,
        [0xda] = 1,
        [0xdb] = 3,
        [0xdc] = 3,
        [0xdd] = 3,
        [0xde] = 3,
        [0xdf] = 3,
        [0xe0] = 2,
        [0xe1] = 2,
        [0xe2] = 2,
        [0xe3] = 2,
        [0xe4] = 2,
        [0xe5] = 2,
        [0xe6] = 2,
        [0xe7] = 2,
        [0xe8] = 1,
        [0xe9] = 2,
        [0xea] = 1,
        [0xeb] = 2,
        [0xec] = 3,
        [0xed] = 3,
        [0xee] = 3,
        [0xef] = 3,
        [0xf0] = 2,
        [0xf1] = 2,
        [0xf2] = 1,
        [0xf3] = 2,
        [0xf4] = 2,
        [0xf5] = 2,
        [0xf6] = 2,
        [0xf7] = 2,
        [0xf8] = 1,
        [0xf9] = 3,
        [0xfa] = 1,
        [0xfb] = 3,
        [0xfc] = 3,
        [0xfd] = 3,
        [0xfe] = 3,
        [0xff] = 3
};

int parser_get_instruction_description(
        unsigned char *buff,
        size_t buffer_size,
        struct instruction_description *desc) {
    int operand_size;

    desc->opcode = buff[0];
    desc->instruction_size = opcode_to_instruction_size[desc->opcode];

    if (desc->instruction_size > buffer_size)
        return -1;

    /* First byte is opcode, rest of data is the operand. */
    operand_size = desc->instruction_size - 1;
    ++buff;

    if (operand_size == 1)
        desc->operand = *buff;
    else
        desc->operand = *(uint16_t*)buff;

    return 0;
}

size_t parser_get_instruction_size(uint8_t opcode) {
	return opcode_to_instruction_size[opcode];
}
